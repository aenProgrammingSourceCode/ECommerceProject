@{

    Layout = "~/Views/Shared/_LayoutHomeProduct.cshtml";
}
<script src="~/Scripts/jquery-jtemplates.js"></script>
@using Microsoft.AspNet.Identity
 

<script type="text/javascript">
    $(document).ready(function () {
        BasketItemDetailsById();
        $(document).on("click", function (e) {
            if ($(e.target).is("img") === false) {
                $("img").removeClass("lens");
            }

        });
    });
    function imglens() {
        $("#myimg").toggleClass("lens");
    }
    function PlaceCustomerOrder()
    {
        CallOrderProcess();
    }
    function CallOrderProcess() {
        var userName = '@Html.Encode(HttpContext.Current.User.Identity.GetUserName())'
        var Identity = '@Html.Encode(HttpContext.Current.User.Identity.GetUserId())'
        var jsonUser = {
            IdentityToken: Identity,
            UserName: userName
        };
        $.ajax({
            url: '/api/Order/PlaceOrder',
            type: 'POST',
            dataType: 'json',
            contentType: 'application/json;charset-utf-8',
            data: JSON.stringify(jsonUser),
            success: function () {
                alert("Order Submitted Successfully");
                //window.location.href = '/Home/Orders';
                $("#orderDetailsHtml").setTemplate($("#orderDetailsTemp").html());
                $("#orderDetailsHtml").processTemplate(data);
              
            },
            error: function (r) {
                var jsonError = JSON.stringify(r);
                //alert("error" + jsonError);
            }
        });
    }
     

    function BasketItemDetailsById()
    {
        $.ajax({
            url: '/api/Basket/GetBasketItemDetails',
            type: 'GET',
            cache: false,
            dataType: 'json',
            contentType: 'application/json;charset-utf-8',
            success: function (data) {
               
                $("#orderTotalQty").empty();
                $("#orderTotalAmount").empty();
                $("#orderTotalItems").empty();
                $("#orderTotalItems2").empty();
                $("#basketItemDetailsHtml").setTemplate($("#basketItemDetailsTemp").html());
                $("#basketItemDetailsHtml").processTemplate(data);
                 
                var totalQty = 0;
                var totalAmt = 0;
                var items = 0;
                for (var i = 0; i < data.length; i++) {
                    totalQty += data[i].Qty;
                    totalAmt += data[i].LineTotal;
                    items = data[i].ProductId;
                }

                items = $("[id^='Qty-']").length;
                
                $("#orderTotalItems2").append(items + " Items");
                $("#orderTotalItems").append(items+" Items");
                $("#orderTotalQty").append(totalQty);
                $("#orderTotalAmount").append(totalAmt + "৳");
            },
            error: function (r) {
                var jsonError = JSON.stringify(r);
                alert("error" + jsonError);
            }
        });
    }
    function UpdateItems() {
        $('#basketItemDetailsHtml').fadeTo(100, 0.3, function () { $(this).fadeTo(500, 1.0); });
        var postArr = [];
        var index = 0;
        var postData;

        $("[id^='Qty-']").each(function () {
            itemElementId = $(this).attr('id');
            var productId = 0;
            productId = itemElementId.replace("Qty-", "");

            postArr[index] = { ProductId: productId, Qty: $(this).val() };
            index++;
        });

        postData = { Items: postArr };

        var jsonData = JSON.stringify(postData);

        $.ajax({
            url: '/api/Basket/UpdateBasketItem',
            type: 'POST',
            cache: false,
            dataType: 'json',
            data: jsonData,
            contentType: 'application/json;charset-utf-8',
            success: function (data) {
                GetBasketSummary();
                BasketItemDetailsById();
            },
            error: function (r) {
                var jsonError = JSON.stringify(r);
                alert("error" + jsonError);
            }
        });
    }
    //function DeleteItems() {
    //    $('#basketItemDetailsHtml').fadeTo(100, 0.3, function () { $(this).fadeTo(500, 1.0); });
    //    var postArr = [];
    //    var index = 0;
    //    var deleteData;

    //    $.each($("input[name='product']:checked"), function () {
    //        postArr[index] = { ProductId: $(this).val() }
    //        index++;
    //    });


    //    deleteData = { Products: postArr };

    //    var jsonData = JSON.stringify(deleteData);

    //    $.ajax({
    //        url: '/api/Basket/DeleteBasketItem',
    //        type: 'POST',
    //        cache: false,
    //        dataType: 'json',
    //        data: jsonData,
    //        contentType: 'application/json;charset-utf-8',
    //        success: function (data) {
    //            GetBasketSummary();
    //            BasketItemDetailsById();
    //        },
    //        error: function (r) {
    //            var jsonError = JSON.stringify(r);
    //            alert("error" + jsonError);
    //        }
    //    });
    //}

    function DeleteBasketItemById(Id)
    {
        $.ajax({
            url: '/api/Basket/Delete?id='+Id,
            type: 'POST',
            cache: false,
            dataType: 'json',
            contentType: 'application/json;charset-utf-8',
            success: function (data) {
                GetBasketSummary();
                BasketItemDetailsById();
            },
            error: function (r) {
                var jsonError = JSON.stringify(r);
                alert("error" + jsonError);
            }
        });
    }
</script>


<style>
    .zoom {
    }

    .lens {
        -ms-transform: scale(1.5); /* IE 9 */
        -webkit-transform: scale(1.5); /* Safari 3-8 */
        transform: scale(5);
    }
</style>


<div class="container">
    <div class="col-md-8">
        <table>
            <tfoot id="basketDetailsHtml">

            </tfoot>
        </table>
        <h4  style="color:#454040">My Shopping Bag (<span id="orderTotalItems"></span>)</h4>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th></th>
                    <th></th>
                    <th>Product Name</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Item Total</th>
                   
                </tr>
            </thead>
            <tbody id="basketItemDetailsHtml">
                @*<h3 class="text-warning" id="noBasketMsg"></h3>*@
            </tbody>
           
        </table>
    </div>
    <div class="col-md-4">
        <P style="color:#454040">PRICE DETAILS</P>
        <hr />

        <table class="table table-hover">
            <tbody>
                <tr>
                    <td style="color:#494343"><span>Total Items :</span> </td> <td style="color:#494343"><span id="orderTotalItems2"></span> </td>
                </tr>
                <tr>
                    <td style="color:#494343"><span>Total Quantity :</span> </td> <td style="color:#494343"> <span id="orderTotalQty"></span></td>
                </tr>
                <tr>
                    <td style="color:#494343"><span>Total Amount :</span> </td> <td style="color:#494343"><span id ="orderTotalAmount"></span></td>
                </tr>
                <tr>
                    
                    <td colspan="2"><a href="/Home/DeliveryAddress" class="btn btn-lg btn-nowoncare">Place Order</a></td>
                </tr>
            </tbody>
        </table>
</div>
</div>
<script type="text/html" id="basketItemDetailsTemp">
    {#foreach $T as record}
    <tr>
        @*<td> <input id="chkDelete" value="{$T.record.ProductId}" name="product" type="checkbox" /></td>*@
        <td><a href="#" onclick="JavaScript: DeleteBasketItemById('{$T.record.Id}')"><span class="glyphicon glyphicon-remove-sign"></span> </a> </td>
        <td> 
            <img style="display:inline-block; border:solid 1px; border-color:#ebd6d6" id="myimg" src="/Content/ProductImage/{$T.record.ProductImageId}.jpg" width="70" class="zoom" onclick="imglens();" />
        </td>
        <td> {$T.record.ProductName}-{$T.record.ProductSizeName}</td>
        <td>
            {$T.record.ProductPrice}৳
        </td>
        <td>
            <select id="Qty-{$T.record.ProductId}" name="pQuantity" onkeyup="JavaScript:UpdateItems()" onchange="UpdateItems();">
                <option selected value="{$T.record.Qty}">{$T.record.Qty}</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
            </select>

            @*<input  name="pQuantity" class="form-control"" type="text" onkeyup="JavaScript:UpdateItems()" />*@
        </td>
        <td>
            {$T.record.LineTotal}৳
        </td>
        
    </tr>
  
    {#/for}
  
    <tr>
        <td colspan="6"><a href="#" class="btn btn-default" onclick="JavaScript: history.back()">Shop More</a></td>
    </tr>
  
</script>
 

    <div id="orderDetailsHtml">

    </div>

    <script type="text/html" id="orderDetailsTemp">
        <table>
            <thead>
                {#foreach $T as record}
                <tr>
                    <td>{$T.record.Id}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                {#/for}
            </thead>
        </table>
    </script>



